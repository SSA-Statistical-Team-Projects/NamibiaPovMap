ord_model
summary(log_model)
devtools::load_all()
#----------------------- EBP MODEL  ESTAIMATION -------------------------------#
## environment set up
remove(list = objects())
options(
stringsAsFactors = F,
width = 100,
scipen = 6,
start.time= Sys.time()
)
pacman::p_load(data.table, dplyr, stringr, fuzzyjoin)
#------------------------------------------------------------------------------#
nam_selvars_list <- readRDS("data-raw/nam_selvars_list.RDS")
census_dt <- readRDS("data-clean/census_dt.RDS")
survey_dt <- readRDS("data-clean/survey_dt.RDS")
census_dt$const_code <- as.numeric(census_dt$const_code)
survey_dt$new_const_code <- as.numeric(survey_dt$new_const_code)
census_dt["wta_hh"] <- lapply(haven::zap_labels(census_dt["wta_hh"]) ,as.numeric)
nam_selvars_list  <- intersect(intersect(nam_selvars_list, names(survey_dt)), names(census_dt))
census_dt <- as.data.table(census_dt)
survey_dt <- as.data.table(survey_dt)
### check that the poverty rates make sense
survey_dt[, !duplicated(colnames(survey_dt)), with = F] %>%
mutate(poor_var = ifelse(wel_PPP < 6249, 1, 0)) %>%
summarize(weighted.mean(x = poor_var,
w = wta_hh,
na.rm = TRUE))
remotes::install_github("SSA-Statistical-Team-Projects/povmap",
ref = "david3")
devtools::load_all()
logunit_model <- readRDS("data-clean/estimation_results/unitmodel_log.RDS")
nam_selvars_list <- readRDS("data-raw/nam_selvars_list.RDS")
census_dt <- readRDS("data-clean/census_dt.RDS")
survey_dt <- readRDS("data-clean/survey_dt.RDS")
census_dt$const_code <- as.numeric(census_dt$const_code)
survey_dt$new_const_code <- as.numeric(survey_dt$new_const_code)
census_dt["wta_hh"] <- lapply(haven::zap_labels(census_dt["wta_hh"]) ,as.numeric)
nam_selvars_list  <- intersect(intersect(nam_selvars_list, names(survey_dt)), names(census_dt))
census_dt <- as.data.table(census_dt)
pacman::p_load(data.table, dplyr, stringr, fuzzyjoin, povmap)
census_dt <- as.data.table(census_dt)
survey_dt <- as.data.table(survey_dt)
### check that the poverty rates make sense
survey_dt[, !duplicated(colnames(survey_dt)), with = F] %>%
mutate(poor_var = ifelse(wel_PPP < 6249, 1, 0)) %>%
summarize(weighted.mean(x = poor_var,
w = wta_hh,
na.rm = TRUE))
nam_selvars_list
colnames(survey_dt)
unique(survey_dt$region_code)
unique(census_dt$region_code)
table(survey_dt$region_code)
table(census_dt$region_code)
table(survey_dt$region_code, useNA = "always")
table(census_dt$region_code, useNA = "always")
table(survey_dt$region_name, useNA = "always")
table(census_dt$region_name, useNA = "always")
table(survey_dt$region_prev_code)
table(census_dt$region_prev_code)
table(survey_dt$region_prev_name)
table(survey_dt$region_prev_code)
table(census_dt$region_code)
survey_dt[, table(region_prev_code, const_code)]
survey_dt[, table(const_code,region_prev_code)]
View(survey_dt[, table(const_code,region_prev_code)])
survey_dt[, table(const_code,region_prev_code)]
direct_dt <- povmap::direct(y = "wel_PPP",
smp_data = na.omit(survey_dt[, c("wel_PPP", nam_selvars_list,
"wta_hh", "hid",
"region_prev_name",
"region_prev_code",
"new_const_code"),
with = FALSE]),
smp_domains = "new_const_code",
weights = "wta_hh",
var = TRUE,
threshold = 6249)
direct_dt
direct_dt$ind
saveRDS(direct_dt, "inst/postestimation/tables/direct_estimates.RDS")
descriptives_dt <-
ebp_reportdescriptives(model = logunit_model,
direct = direct_dt,
smp_data = na.omit(survey_dt[, c("wel_PPP", nam_selvars_list,
"wta_hh", "hid",
"region_prev_name",
"region_prev_code",
"new_const_code"),
with = FALSE]),
weights = "wta_hh",
pop_weights = "new_const_code",
CV_level = "region_prev_name",
pop_data = census_dt,
pop_domains = "new_const_code",
threshold = 6249)
descriptives_dt <-
ebp_reportdescriptives(model = logunit_model,
direct = direct_dt,
smp_data = as.data.frame(na.omit(survey_dt[, c("wel_PPP", nam_selvars_list,
"wta_hh", "hid",
"region_prev_name",
"region_prev_code",
"new_const_code"),
with = FALSE])),
weights = "wta_hh",
pop_weights = "new_const_code",
CV_level = "region_prev_name",
pop_data = as.data.frame(census_dt),
pop_domains = "new_const_code",
threshold = 6249)
as.data.frame(na.omit(survey_dt[, c("wel_PPP", nam_selvars_list,
"wta_hh", "hid",
"region_prev_name",
"region_prev_code",
"new_const_code"),
with = FALSE])
)
census_dt[, c(nam_selvars_list,
"wta_hh", "hid",
"region_prev_name",
"region_prev_code",
"new_const_code")]
census_dt[, c(nam_selvars_list,
"wta_hh", "hid",
"region_prev_name",
"region_prev_code",
"new_const_code"), with = F]
na.omit(survey_dt[, c("wel_PPP", nam_selvars_list,
"wta_hh", "hid",
"new_const_code"),
with = FALSE]) %>%
mutate(const_code = new_const_code)
descriptives_dt <-
ebp_reportdescriptives(model = logunit_model,
direct = direct_dt,
smp_data = na.omit(survey_dt[, c("wel_PPP", nam_selvars_list,
"wta_hh", "hid",
"new_const_code"),
with = FALSE]) %>%
mutate(const_code = new_const_code),
weights = "wta_hh",
pop_weights = "wta_hh",
CV_level = "region_prev_name",
pop_data = census_dt,
pop_domains = "const_code",
threshold = 6249)
census_dt[, c(nam_selvars_list, "new_const_code", "wta_hh", "hid")]
census_dt[, c(nam_selvars_list, "new_const_code", "wta_hh", "hid"), with = F]
census_dt[, c(nam_selvars_list, "const_code", "wta_hh", "hid"), with = F]
descriptives_dt <-
ebp_reportdescriptives(model = logunit_model,
direct = direct_dt,
smp_data = na.omit(survey_dt[, c("wel_PPP", nam_selvars_list,
"wta_hh", "hid",
"new_const_code"),
with = FALSE]) %>%
mutate(const_code = new_const_code),
weights = "wta_hh",
pop_weights = "wta_hh",
CV_level = "region_prev_name",
pop_data = census_dt,
pop_domains = "const_code",
threshold = 6249)
census_dt[, c(nam_selvars_list,
"wta_hh", "hid",
"const_code", "region_prev_name"), with = F]
unique(survey_dt$region_name)
unique(census_dt$region_name)
unique(census_dt$region_code)
unique(survey_dt$region_code)
unique(survey_dt$region_prev_code)
unique(survey_dt$const_code)
descriptives_dt <-
ebp_reportdescriptives(model = logunit_model,
direct = direct_dt,
smp_data = na.omit(survey_dt[, c("wel_PPP", nam_selvars_list,
"wta_hh", "hid",
"new_const_code"),
with = FALSE]) %>%
mutate(const_code = new_const_code),
weights = "wta_hh",
pop_weights = "wta_hh",
CV_level = "region_prev_code",
pop_data = census_dt,
pop_domains = "const_code",
threshold = 6249)
descriptives_dt <-
ebp_reportdescriptives(model = logunit_model,
direct = direct_dt,
smp_data = as.data.frame(na.omit(survey_dt[, c("wel_PPP", nam_selvars_list,
"wta_hh", "hid",
"new_const_code"),
with = FALSE]) %>%
mutate(const_code = new_const_code)),
weights = "wta_hh",
pop_weights = "wta_hh",
CV_level = "region_prev_code",
pop_data = as.data.frame(census_dt),
pop_domains = "const_code",
threshold = 6249)
survey_dt <-
survey_dt %>%
mutate(const_code = new_const_code)
survey_dt <-
survey_dt %>%
mutate(const_code2 = new_const_code)
survey_dt$const_code <- survey_dt$new_const_code
unique(census_dt$region_code)
descriptives_dt <-
ebp_reportdescriptives(model = logunit_model,
direct = direct_dt,
smp_data = as.data.frame(na.omit(survey_dt[, c("wel_PPP", nam_selvars_list,
"wta_hh", "hid",
"const_code"),
with = FALSE])),
weights = "wta_hh",
pop_weights = "wta_hh",
CV_level = "region_code",
pop_data = as.data.frame(census_dt),
pop_domains = "const_code",
threshold = 6249)
census_dt[,nam_selvars_list,with=F]
as.data.frame(na.omit(survey_dt[, c("wel_PPP", nam_selvars_list,
"wta_hh", "hid",
"const_code"),
with = FALSE]))
census_dt$region_code
unique(survey_dt$region_code)
unique(census_dt$region_code)
unique(survey_dt$region_prev_code)
unique(census_dt$region_code)
census_dt$region_prev_code <- census_dt$region_code
descriptives_dt <-
ebp_reportdescriptives(model = logunit_model,
direct = direct_dt,
smp_data = as.data.frame(na.omit(survey_dt[, c("wel_PPP", nam_selvars_list,
"wta_hh", "hid", "region_prev_code",
"const_code"),
with = FALSE])),
weights = "wta_hh",
pop_weights = "wta_hh",
CV_level = "region_prev_code",
pop_data = as.data.frame(census_dt),
pop_domains = "const_code",
threshold = 6249)
str(as.data.frame(na.omit(survey_dt[, c("wel_PPP", nam_selvars_list,
"wta_hh", "hid", "region_prev_code",
"const_code"),
with = FALSE])))
debug(ebp_reportdescriptives)
descriptives_dt <-
ebp_reportdescriptives(model = logunit_model,
direct = direct_dt,
smp_data = as.data.frame(na.omit(survey_dt[, c("wel_PPP", nam_selvars_list,
"wta_hh", "hid", "region_prev_code",
"const_code"),
with = FALSE])),
weights = "wta_hh",
pop_weights = "wta_hh",
CV_level = "region_prev_code",
pop_data = as.data.frame(census_dt),
pop_domains = "const_code",
threshold = 6249)
undebug(ebp_reportdescriptives)
test_dt <- as.data.frame(na.omit(survey_dt[, c("wel_PPP", nam_selvars_list,
"wta_hh", "hid", "region_prev_code",
"const_code"),
with = FALSE]))
names(tapply(test_dt[["wta_hh"]],
test_dt[["const_code"]], sum, na.rm = TRUE))
tapply(test_dt[["wta_hh"]],
+              test_dt[["const_code"]], sum, na.rm = TRUE)
descriptives_dt <-
ebp_reportdescriptives(model = logunit_model,
direct = direct_dt,
smp_data = na.omit(survey_dt[, c("wel_PPP", nam_selvars_list,
"wta_hh", "hid", "region_prev_code",
"const_code"),
with = FALSE]),
weights = "wta_hh",
pop_weights = "wta_hh",
CV_level = "region_prev_code",
pop_data = census_dt,
pop_domains = "const_code",
threshold = 6249)
descriptives_dt <-
ebp_reportdescriptives(model = logunit_model,
direct = direct_dt,
smp_data = as.data.frame(na.omit(survey_dt[, c("wel_PPP", nam_selvars_list,
"wta_hh", "hid", "region_prev_code",
"const_code"),
with = FALSE])),
weights = "wta_hh",
pop_weights = "wta_hh",
CV_level = "region_prev_code",
pop_data = census_dt,
pop_domains = "const_code",
threshold = 6249)
descriptives_dt <-
ebp_reportdescriptives(model = logunit_model,
direct = direct_dt,
smp_data = as.data.frame(na.omit(survey_dt[, c("wel_PPP", nam_selvars_list,
"wta_hh", "hid", "region_prev_code",
"const_code"),
with = FALSE])),
weights = "wta_hh",
pop_weights = "wta_hh",
CV_level = "region_prev_code",
pop_data = as.data.frame(census_dt),
pop_domains = "const_code",
threshold = 6249)
debug(ebp_reportdescriptives)
descriptives_dt <-
ebp_reportdescriptives(model = logunit_model,
direct = direct_dt,
smp_data = as.data.frame(na.omit(survey_dt[, c("wel_PPP", nam_selvars_list,
"wta_hh", "hid", "region_prev_code",
"const_code"),
with = FALSE])),
weights = "wta_hh",
pop_weights = "wta_hh",
CV_level = "region_prev_code",
pop_data = as.data.frame(census_dt),
pop_domains = "const_code",
threshold = 6249)
data.frame(Domain = names(tapply(smp_df[[weights]],
smp_df[[model$framework$smp_domains]], sum, na.rm = TRUE)),
weights = tapply(smp_df[[weights]], smp_df[[model$framework$smp_domains]],
sum, na.rm = TRUE))
length(names(tapply(smp_df[[weights]],
smp_df[[model$framework$smp_domains]], sum, na.rm = TRUE)))
smp_dt[[weights]]
smp_df[[weights]]
str(smp_df[[weights]])
str(smp_df[[model$framework$smp_domains]])
model$framework$smp_domains
undebug(ebp_reportdescriptives)
descriptives_dt <-
ebp_reportdescriptives(model = logunit_model,
direct = direct_dt,
smp_data = as.data.frame(na.omit(survey_dt[, c("wel_PPP", nam_selvars_list,
"wta_hh", "hid", "region_prev_code",
"const_code", "new_const_code"),
with = FALSE])),
weights = "wta_hh",
pop_weights = "wta_hh",
CV_level = "region_prev_code",
pop_data = as.data.frame(census_dt),
pop_domains = "const_code",
threshold = 6249)
as.data.frame(na.omit(survey_dt[, c("wel_PPP", nam_selvars_list,
"wta_hh", "hid", "region_prev_code",
"const_code", "new_const_code"),
with = FALSE]))
debug(ebp_reportdescriptives)
descriptives_dt <-
ebp_reportdescriptives(model = logunit_model,
direct = direct_dt,
smp_data = as.data.frame(na.omit(survey_dt[, c("wel_PPP", nam_selvars_list,
"wta_hh", "hid", "region_prev_code",
"const_code", "new_const_code"),
with = FALSE])),
weights = "wta_hh",
pop_weights = "wta_hh",
CV_level = "region_prev_code",
pop_data = as.data.frame(census_dt),
pop_domains = "const_code",
threshold = 6249)
str(tapply(smp_df[[weights]])
)
str(smp_df[[weights]])
str(smp_df[[model$framework$smp_domains]])
smp_df
str(smp_df)
model$framework$smp_domains
colnames(model$framework$smp_data)
summary(model)
model$framework$smp_domains
descriptives_dt <-
ebp_reportdescriptives(model = logunit_model,
direct = direct_dt,
smp_data = as.data.frame(na.omit(survey_dt[, c("wel_PPP", nam_selvars_list,
"wta_hh", "hid", "region_prev_code",
"const_code", "new_const_code"),
with = FALSE])),
weights = "wta_hh",
pop_weights = "wta_hh",
CV_level = "region_prev_code",
pop_data = as.data.frame(census_dt),
pop_domains = "const_code",
threshold = 6249)
model$framework$smp_data
colnames(model$model$data)
logunit_model$framework$smp_data
logunit_model$framework$smp_data <- logunit_model$model$data
descriptives_dt <-
ebp_reportdescriptives(model = logunit_model,
direct = direct_dt,
smp_data = as.data.frame(na.omit(survey_dt[, c("wel_PPP", nam_selvars_list,
"wta_hh", "hid", "region_prev_code",
"const_code", "new_const_code"),
with = FALSE])),
weights = "wta_hh",
pop_weights = "wta_hh",
CV_level = "region_prev_code",
pop_data = as.data.frame(census_dt),
pop_domains = "const_code",
threshold = 6249)
undebug(ebp_reportdescriptives)
descriptives_dt <-
ebp_reportdescriptives(model = logunit_model,
direct = direct_dt,
smp_data = as.data.frame(na.omit(survey_dt[, c("wel_PPP", nam_selvars_list,
"wta_hh", "hid", "region_prev_code",
"const_code", "new_const_code"),
with = FALSE])),
weights = "wta_hh",
pop_weights = "wta_hh",
CV_level = "region_prev_code",
pop_data = as.data.frame(census_dt),
pop_domains = "const_code",
threshold = 6249)
census_dt$const_code
logunit_model$fixed
logunit_model$fixed[2]
c(paste(model$fixed[2]),
"wta_hh"))
c(paste(model$fixed[2]),
"wta_hh")
c(paste(logunit_model$fixed[2]),
"wta_hh")
hh_varlist <- colnames(logunit_model$framework$smp_data)
hh_varlist[!(hh_varlist %in% c(paste(logunit_model$fixed[2]),
weights))]
hh_varlist <- hh_varlist[!(hh_varlist %in% c(paste(logunit_model$fixed[2]),
weights))]
hh_varlist
census_dt[,hh_varlist, with = F]
census_dt$new_const_code <- census_dt$const_code
descriptives_dt <-
ebp_reportdescriptives(model = logunit_model,
direct = direct_dt,
smp_data = as.data.frame(na.omit(survey_dt[, c("wel_PPP", nam_selvars_list,
"wta_hh", "hid", "region_prev_code",
"const_code", "new_const_code"),
with = FALSE])),
weights = "wta_hh",
pop_weights = "wta_hh",
CV_level = "region_prev_code",
pop_data = as.data.frame(census_dt),
pop_domains = "new_const_code",
threshold = 6249)
descriptives-dt
descriptives_dt
descriptives_dt <-
ebp_reportdescriptives(model = logunit_model,
direct = direct_dt,
smp_data = as.data.frame(survey_dt),
weights = "wta_hh",
pop_weights = "wta_hh",
CV_level = "region_prev_code",
pop_data = as.data.frame(census_dt),
pop_domains = "new_const_code",
threshold = 6249)
rm(test_dt)
logunit_model$model$varFix
checkvariables_dt <-
ebp_test_means(varlist = nam_selvars_list,
pop_data = census_dt,
smp_data = survey_dt,
weights = "wta_hh")
checkvariables_dt <-
ebp_test_means(varlist = nam_selvars_list,
pop_data = as.data.frame(census_dt),
smp_data = as.data.frame(survey_dt),
weights = "wta_hh")
checkvariables_dt
write.csv(checkvariables_dt,
"postestimation/tables/compare_samplecensus_means.csv")
write.csv(checkvariables_dt,
"inst/postestimation/tables/compare_samplecensus_means.csv")
ebp_modelresults_dt <- ebp_reportcoef_table(logunit_model, 4)
ebp_modelresults_dt
write.csv(ebp_modelresults_dt,
"inst/postestimation/tables/ebp_regressionresults.csv")
colnames(survey_dt)
table(survey_dt$strata)
table(survey_dt$strata, useNA = "always")
table(survey_dt$cluster, useNA = "always")
as.data.frame(na.omit(survey_dt[!is.na(new_const_code),
c(nam_selvars_list,
"new_const_code",
"wta_hh", "cluster"),
with = FALSE]))$cluster
logunit_model$framework$smp_data$cluster <-
as.data.frame(na.omit(survey_dt[!is.na(new_const_code),
c(nam_selvars_list,
"new_const_code",
"wta_hh", "cluster"),
with = FALSE]))$cluster
cv_dt <- ebp_compute_cv(model = logunit_model,
designvar = "cluster",
threshold = 6249,
calibvar = "new_const_code")
cv-dt
cv_dt
write.csv(cv_dt, "inst/postestimation/tables/targetarea_cvtable.csv")
plot(logunit_model)
devtools::load_all()
